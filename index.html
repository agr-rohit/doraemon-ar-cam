<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Doraemon AR Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --dora-blue: #0096D9;
            --dora-red: #E50012;
            --glass: rgba(255, 255, 255, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background: #000; 
            font-family: 'Inter', sans-serif; 
            height: 100svh; width: 100vw; 
            overflow: hidden; 
            position: fixed;
        }

        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* The Viewport */
        canvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            touch-action: none; /* Critical for custom gestures */
        }

        /* Professional UI Overlay */
        .ui-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: calc(20px + env(safe-area-inset-top)) 20px calc(30px + env(safe-area-inset-bottom)) 20px;
        }

        .header {
            pointer-events: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-badge {
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-weight: 700;
            letter-spacing: 1px;
            font-size: 14px;
        }

        .controls-footer {
            pointer-events: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        /* Shutter Button */
        .shutter-btn {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            border: 6px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .shutter-btn:active { transform: scale(0.9); }
        .shutter-inner { width: 60px; height: 60px; border: 2px solid #000; border-radius: 50%; }

        /* Preview System */
        #flash {
            position: fixed; inset: 0; background: white;
            opacity: 0; pointer-events: none; z-index: 100;
        }

        #preview-modal {
            position: fixed; inset: 0; background: #000;
            display: none; flex-direction: column; 
            z-index: 200; padding: 40px 20px;
        }
        #preview-modal img { 
            width: 100%; height: 80%; object-fit: contain; 
            border-radius: 20px;
        }
        
        .modal-btns {
            display: flex; gap: 20px; margin-top: 20px;
            justify-content: center;
        }

        .primary-btn {
            background: var(--dora-blue); color: white;
            border: none; padding: 15px 40px; border-radius: 12px;
            font-weight: 700; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="flash"></div>

<div id="app-container">
    <canvas id="arCanvas"></canvas>
    
    <div class="ui-layer">
        <div class="header">
            <div class="logo-badge">DORAEMON AR PRO</div>
        </div>

        <div class="controls-footer">
            <div class="shutter-btn" id="captureBtn">
                <div class="shutter-inner"></div>
            </div>
        </div>
    </div>
</div>

<div id="preview-modal">
    <img id="savedImage" src="" alt="Captured">
    <div class="modal-btns">
        <button class="primary-btn" onclick="closePreview()">RETAKE</button>
        <p style="color: #666; font-size: 12px; text-align: center; margin-top: 10px;">Long-press image to save to gallery</p>
    </div>
</div>

<video id="video" autoplay playsinline style="display:none;"></video>

<script>
const canvas = document.getElementById('arCanvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('video');
const flash = document.getElementById('flash');
const doraemonImg = new Image();
doraemonImg.src = 'doraemon.png';

// State Management
let dX = 0, dY = 0, dWidth = 200;
let isDragging = false;
let startX, startY;
let initialPinchDist = null;
let initialWidth = null;

// Initialization
async function init() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }, 
            audio: false 
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            // Center Doraemon initially
            dX = canvas.width / 2 - dWidth / 2;
            dY = canvas.height / 2 - dWidth / 2;
            render();
        };
    } catch (e) {
        alert("Camera Access Required for AR");
    }
}

function render() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(doraemonImg, dX, dY, dWidth, dWidth);
    requestAnimationFrame(render);
}

// Advanced Gesture Handling
canvas.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        // Convert screen touch to canvas coordinates
        const touchX = (touch.clientX - rect.left) * (canvas.width / rect.width);
        const touchY = (touch.clientY - rect.top) * (canvas.height / rect.height);

        // Check if we touched Doraemon
        if (touchX >= dX && touchX <= dX + dWidth && touchY >= dY && touchY <= dY + dWidth) {
            isDragging = true;
            startX = touchX - dX;
            startY = touchY - dY;
        }
    } else if (e.touches.length === 2) {
        isDragging = false;
        initialPinchDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        initialWidth = dWidth;
    }
}, { passive: false });

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();

    if (e.touches.length === 1 && isDragging) {
        const touch = e.touches[0];
        dX = ((touch.clientX - rect.left) * (canvas.width / rect.width)) - startX;
        dY = ((touch.clientY - rect.top) * (canvas.height / rect.height)) - startY;
    } 
    else if (e.touches.length === 2 && initialPinchDist) {
        const currentDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        
        // Scaling Logic
        const scale = currentDist / initialPinchDist;
        const newWidth = initialWidth * scale;
        
        if (newWidth > 50 && newWidth < canvas.width) {
            // Anchor scaling to center
            dX -= (newWidth - dWidth) / 2;
            dY -= (newWidth - dWidth) / 2;
            dWidth = newWidth;
        }
    }
}, { passive: false });

canvas.addEventListener('touchend', () => {
    isDragging = false;
    initialPinchDist = null;
});

// Capture and Visual Effects
document.getElementById('captureBtn').onclick = () => {
    // Flash effect
    flash.style.opacity = '1';
    setTimeout(() => flash.style.opacity = '0', 100);

    // Save
    const dataURL = canvas.toDataURL('image/png');
    document.getElementById('savedImage').src = dataURL;
    document.getElementById('preview-modal').style.display = 'flex';
};

function closePreview() {
    document.getElementById('preview-modal').style.display = 'none';
}

init();
</script>
</body>
</html>